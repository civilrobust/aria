<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ARIA Radiology Workbench · King's College Hospital</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Mono:wght@300;400;500&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}

/* ══════════════════════════════════════════
   CSS VARIABLES — DARK (default)
══════════════════════════════════════════ */
:root {
  --bg0:#0e1117; --bg1:#151b24; --bg2:#1c2433; --bg3:#232d3f;
  --bg-hover:rgba(0,94,184,0.08); --bg-active:rgba(0,94,184,0.14);
  --nhs:#003087; --nhs2:#005eb8; --accent:#00aaff; --accent2:#00d4aa;
  --urgent:#e8001e; --warn:#e07b00; --ok:#00914d; --info:#7b61ff;
  --text0:#f0f4ff; --text1:#a8bacf; --text2:#5a7090; --text3:#334455;
  --border:rgba(255,255,255,0.07); --border2:rgba(0,170,255,0.2);
  --shadow:0 2px 16px rgba(0,0,0,0.4); --shadow2:0 8px 40px rgba(0,0,0,0.6);
  --glow:0 0 24px rgba(0,170,255,0.2); --glow-r:0 0 20px rgba(232,0,30,0.3);
  --font-h:'DM Serif Display',serif; --font-m:'DM Mono',monospace; --font-s:'DM Sans',sans-serif;
  --rail:64px; --header:52px;
  --card-r:8px;
}
/* ── LIGHT ── */
[data-theme="light"] {
  --bg0:#eef1f6; --bg1:#f8f9fc; --bg2:#ffffff; --bg3:#f0f3f8;
  --bg-hover:rgba(0,48,135,0.04); --bg-active:rgba(0,48,135,0.09);
  --accent:#005eb8; --accent2:#007f6e;
  --urgent:#c0001a; --warn:#b06000; --ok:#006b32;
  --text0:#0a1628; --text1:#3a5070; --text2:#7090aa; --text3:#b0c4d8;
  --border:rgba(0,30,80,0.1); --border2:rgba(0,94,184,0.25);
  --shadow:0 1px 8px rgba(0,20,60,0.08); --shadow2:0 4px 24px rgba(0,20,60,0.12);
  --glow:0 2px 12px rgba(0,94,184,0.15); --glow-r:0 2px 12px rgba(192,0,26,0.15);
}

/* ══════════════════════════════════════════ BASE */
html,body{height:100%;background:var(--bg0);color:var(--text0);font-family:var(--font-s);font-size:13px;overflow:hidden;transition:background .25s,color .25s}
#root{height:100%}
input,button,select,textarea{font-family:var(--font-s)}
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px}
button{cursor:pointer;border:none;outline:none}
input,textarea{outline:none}

/* ══════════════════════════════════════════ LOGIN */
.login-wrap{
  position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
  background:linear-gradient(135deg,#001a4d 0%,#003087 40%,#005eb8 70%,#0080c8 100%);
  z-index:1000;
}
.login-wrap::before{
  content:'';position:absolute;inset:0;pointer-events:none;
  background-image:linear-gradient(rgba(255,255,255,0.03) 1px,transparent 1px),
    linear-gradient(90deg,rgba(255,255,255,0.03) 1px,transparent 1px);
  background-size:48px 48px;
}
.login-wrap::after{
  content:'';position:absolute;inset:0;pointer-events:none;
  background:radial-gradient(ellipse at 30% 50%,rgba(0,200,255,0.08) 0%,transparent 60%),
    radial-gradient(ellipse at 70% 50%,rgba(0,80,200,0.1) 0%,transparent 60%);
}
.login-card{
  background:rgba(255,255,255,0.97);border-radius:16px;padding:48px 44px;width:420px;
  box-shadow:0 24px 80px rgba(0,0,0,0.4),0 0 0 1px rgba(255,255,255,0.1);
  position:relative;z-index:1;
  animation:card-in 0.5s cubic-bezier(0.34,1.56,0.64,1) both;
}
@keyframes card-in{from{opacity:0;transform:translateY(24px) scale(0.96)}to{opacity:1;transform:translateY(0) scale(1)}}
.login-avatar{
  width:72px;height:72px;margin:0 auto 16px;border-radius:50%;
  background:linear-gradient(135deg,#003087,#005eb8);
  display:flex;align-items:center;justify-content:center;
  box-shadow:0 8px 24px rgba(0,48,135,0.35);
  font-size:28px;color:white;font-family:var(--font-h);font-style:italic;
}
.login-title{font-family:var(--font-h);font-size:32px;font-weight:400;color:#003087;text-align:center;font-style:italic;margin-bottom:4px}
.login-sub{font-size:12px;color:#5a7090;text-align:center;letter-spacing:0.06em;margin-bottom:6px}
.login-badge{display:inline-block;background:#003087;color:white;font-size:9px;font-weight:700;letter-spacing:0.12em;padding:3px 10px;border-radius:12px;margin-bottom:28px}
.login-label{font-size:10px;font-weight:600;letter-spacing:0.1em;color:#5a7090;text-transform:uppercase;margin-bottom:6px;display:block}
.login-input{
  width:100%;padding:11px 14px;border:1.5px solid #d0dae8;border-radius:8px;
  font-size:14px;color:#0a1628;background:white;margin-bottom:16px;
  transition:border-color .2s,box-shadow .2s;
}
.login-input:focus{border-color:#005eb8;box-shadow:0 0 0 3px rgba(0,94,184,0.12)}
.login-btn{
  width:100%;padding:13px;background:#003087;color:white;border-radius:8px;
  font-size:13px;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;
  transition:all .2s;box-shadow:0 4px 16px rgba(0,48,135,0.3);margin-bottom:20px;
}
.login-btn:hover{background:#002468;box-shadow:0 6px 24px rgba(0,48,135,0.4);transform:translateY(-1px)}
.login-btn:active{transform:translateY(0)}
.login-btn:disabled{opacity:0.6;cursor:not-allowed;transform:none}
.login-confidential{font-size:11px;color:#c0001a;font-weight:600;text-align:center;margin-bottom:4px}
.login-footer{font-size:10px;color:#8090a0;text-align:center;line-height:1.7}
.login-error{background:#fff0f0;border:1px solid #ffc0c8;border-radius:6px;padding:10px 14px;font-size:12px;color:#c0001a;margin-bottom:16px;text-align:center}

/* ══════════════════════════════════════════ APP SHELL */
.app{display:grid;grid-template-columns:var(--rail) 1fr;grid-template-rows:var(--header) 1fr;height:100vh;transition:all .25s}

/* ── TOP BAR ── */
.topbar{
  grid-column:1/-1;display:flex;align-items:center;gap:0;
  background:var(--nhs);border-bottom:1px solid rgba(255,255,255,0.1);
  position:relative;z-index:200;box-shadow:0 2px 16px rgba(0,0,0,0.3);
}
.topbar::after{content:'';position:absolute;bottom:0;left:0;right:0;height:2px;background:linear-gradient(90deg,#005eb8,#00843d,#ffb81c);opacity:0.6}
.topbar-logo{width:var(--rail);display:flex;align-items:center;justify-content:center;flex-shrink:0}
.nhs-sq{background:white;color:#003087;font-weight:900;font-size:13px;padding:4px 7px;border-radius:3px;letter-spacing:-0.02em}
.topbar-brand{padding:0 20px;border-right:1px solid rgba(255,255,255,0.12)}
.topbar-brand h1{font-family:var(--font-h);font-size:17px;font-style:italic;color:white;letter-spacing:0.02em}
.topbar-brand p{font-size:9px;color:rgba(255,255,255,0.5);letter-spacing:0.1em;margin-top:1px}
.topbar-banner{flex:1;display:flex;align-items:center;gap:0;padding:0 16px;overflow:hidden}
.banner-field{padding:0 16px;border-right:1px solid rgba(255,255,255,0.1)}
.banner-field:last-child{border-right:none}
.bf-label{font-size:8px;color:rgba(255,255,255,0.4);letter-spacing:0.1em;text-transform:uppercase;margin-bottom:1px}
.bf-val{font-size:12px;color:white;font-family:var(--font-m);font-weight:400}
.bf-val.alert{color:#ffb81c}
.topbar-right{display:flex;align-items:center;gap:12px;padding:0 16px}
.theme-tog{display:flex;background:rgba(255,255,255,0.1);border-radius:20px;padding:3px;border:1px solid rgba(255,255,255,0.15)}
.ttb{padding:3px 10px;border-radius:16px;font-size:9px;font-weight:700;letter-spacing:0.1em;background:transparent;color:rgba(255,255,255,0.45);transition:all .2s;border:none}
.ttb.on{background:rgba(255,255,255,0.9);color:#003087}
.topbar-user{display:flex;align-items:center;gap:8px}
.user-chip{background:rgba(255,255,255,0.15);border-radius:20px;padding:5px 12px;font-size:11px;color:white;font-weight:500}
.logout-btn{background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);color:rgba(255,255,255,0.7);padding:5px 12px;border-radius:6px;font-size:10px;font-weight:600;letter-spacing:0.08em;transition:all .2s}
.logout-btn:hover{background:rgba(255,255,255,0.2)}
.live-pill{display:flex;align-items:center;gap:5px;font-size:9px;font-weight:700;letter-spacing:0.12em;color:#6effb4}
.live-d{width:6px;height:6px;border-radius:50%;background:#6effb4;animation:pd 1.5s ease-in-out infinite}
@keyframes pd{0%,100%{opacity:1}50%{opacity:0.3}}

/* ── RAIL ── */
.rail{
  background:var(--bg1);border-right:1px solid var(--border);
  display:flex;flex-direction:column;align-items:center;padding:12px 0;gap:4px;
  overflow:hidden;z-index:100;
}
.rail-btn{
  width:44px;height:44px;border-radius:10px;display:flex;flex-direction:column;
  align-items:center;justify-content:center;gap:2px;background:transparent;
  color:var(--text2);transition:all .2s;position:relative;
}
.rail-btn:hover{background:var(--bg-hover);color:var(--text1)}
.rail-btn.active{background:var(--bg-active);color:var(--accent)}
.rail-btn.active::before{content:'';position:absolute;left:0;top:50%;transform:translateY(-50%);width:3px;height:24px;background:var(--accent);border-radius:0 3px 3px 0}
.rail-icon{font-size:18px;line-height:1}
.rail-label{font-size:7px;font-weight:700;letter-spacing:0.06em;text-transform:uppercase}
.rail-spacer{flex:1}
.rail-divider{width:32px;height:1px;background:var(--border);margin:4px 0}

/* ── WORKSPACE ── */
.workspace{background:var(--bg0);overflow:hidden;display:flex;flex-direction:column}

/* ══════════════════════════════════════════ WORKLIST */
.wl-wrap{display:grid;grid-template-rows:auto 1fr;height:100%;overflow:hidden}
.wl-toolbar{
  padding:12px 16px;background:var(--bg1);border-bottom:1px solid var(--border);
  display:flex;align-items:center;gap:10px;flex-wrap:wrap;
}
.wl-title{font-family:var(--font-h);font-size:20px;font-style:italic;color:var(--text0);margin-right:8px;white-space:nowrap}
.search-box{
  display:flex;align-items:center;gap:8px;background:var(--bg2);border:1px solid var(--border);
  border-radius:8px;padding:7px 12px;flex:1;min-width:180px;max-width:280px;
}
.search-box input{background:transparent;border:none;color:var(--text0);font-size:12px;width:100%}
.search-box input::placeholder{color:var(--text2)}
.filter-sel{
  background:var(--bg2);border:1px solid var(--border);color:var(--text1);
  border-radius:8px;padding:7px 10px;font-size:11px;font-family:var(--font-s);
}
.filter-sel:focus{border-color:var(--border2)}
.wl-stat{padding:5px 12px;border-radius:6px;font-size:10px;font-weight:700;letter-spacing:0.06em;border:1px solid;background:transparent}
.wl-stat.red{color:var(--urgent);border-color:var(--urgent);background:rgba(232,0,30,0.06)}
.wl-stat.amb{color:var(--warn);border-color:var(--warn);background:rgba(224,123,0,0.06)}
.wl-stat.grn{color:var(--ok);border-color:var(--ok);background:rgba(0,145,77,0.06)}

.table-wrap{overflow:auto;flex:1}
table{width:100%;border-collapse:collapse;font-size:11px}
thead th{
  padding:9px 12px;text-align:left;font-size:9px;font-weight:700;letter-spacing:0.1em;
  text-transform:uppercase;color:var(--text2);background:var(--bg1);
  border-bottom:1px solid var(--border);position:sticky;top:0;z-index:10;white-space:nowrap;
}
tbody tr{border-bottom:1px solid var(--border);cursor:pointer;transition:background .1s}
tbody tr:hover{background:var(--bg-hover)}
tbody tr.active-row{background:var(--bg-active)}
tbody td{padding:10px 12px;color:var(--text1);vertical-align:middle;white-space:nowrap}
tbody td.primary{color:var(--text0);font-weight:600}
.pri-badge{font-size:9px;padding:2px 7px;border-radius:10px;font-weight:700;letter-spacing:0.06em;font-family:var(--font-m)}
.pri-e{background:rgba(232,0,30,0.12);color:var(--urgent);border:1px solid var(--urgent)}
.pri-u{background:rgba(224,123,0,0.12);color:var(--warn);border:1px solid var(--warn)}
.pri-r{background:rgba(0,145,77,0.1);color:var(--ok);border:1px solid var(--ok)}
.mod-tag{font-size:9px;padding:2px 7px;border-radius:4px;font-family:var(--font-m);font-weight:700}
.m-CT{background:rgba(0,170,255,0.12);color:var(--accent)}
.m-MRI{background:rgba(0,212,170,0.12);color:var(--accent2)}
.m-XR{background:rgba(224,123,0,0.12);color:var(--warn)}
.m-US{background:rgba(123,97,255,0.12);color:#9b81ff}
.m-NM{background:rgba(255,97,200,0.12);color:#ff80d0}
.crit-flag{color:var(--urgent);font-size:14px;animation:cfp 1.5s ease-in-out infinite}
@keyframes cfp{0%,100%{opacity:1}50%{opacity:0.3}}
.rs-badge{font-size:9px;padding:2px 7px;border-radius:10px;font-family:var(--font-m)}
.rs-U{background:rgba(224,123,0,0.1);color:var(--warn)}
.rs-P{background:rgba(0,170,255,0.1);color:var(--accent)}
.rs-F{background:rgba(0,145,77,0.1);color:var(--ok)}
.rs-D{background:rgba(255,255,255,0.05);color:var(--text2)}
.empty-state{padding:60px;text-align:center;color:var(--text2)}
.empty-icon{font-size:40px;margin-bottom:12px;opacity:0.3}

/* ══════════════════════════════════════════ STUDY VIEWER */
.viewer-wrap{display:grid;grid-template-columns:200px 1fr 320px;height:100%;overflow:hidden;gap:0}
.series-panel{background:var(--bg1);border-right:1px solid var(--border);overflow-y:auto;padding:10px}
.series-title{font-size:9px;font-weight:700;letter-spacing:0.1em;color:var(--text2);text-transform:uppercase;margin-bottom:10px;padding-bottom:6px;border-bottom:1px solid var(--border)}
.series-item{
  padding:8px 10px;border-radius:6px;margin-bottom:4px;cursor:pointer;border:1px solid transparent;
  transition:all .15s;background:var(--bg2);
}
.series-item:hover{border-color:var(--border2);background:var(--bg3)}
.series-item.active{border-color:var(--accent);background:var(--bg-active)}
.series-num{font-size:9px;color:var(--text2);font-family:var(--font-m);margin-bottom:2px}
.series-desc{font-size:11px;color:var(--text0);font-weight:500}

.viewer-canvas{background:#000;position:relative;display:flex;align-items:center;justify-content:center;overflow:hidden}
.viewer-canvas::before{content:'';position:absolute;inset:0;background:radial-gradient(ellipse at center,#1a1a2a 0%,#000 70%)}
.dicom-img{
  position:relative;z-index:1;width:520px;height:520px;border-radius:4px;overflow:hidden;
  display:flex;align-items:center;justify-content:center;
}
.dicom-overlay-tl,.dicom-overlay-tr,.dicom-overlay-bl,.dicom-overlay-br{
  position:absolute;font-size:10px;color:rgba(255,255,0,0.85);font-family:var(--font-m);
  line-height:1.7;z-index:3;pointer-events:none;text-shadow:1px 1px 2px rgba(0,0,0,0.9);
}
.dicom-overlay-tl{top:10px;left:10px}
.dicom-overlay-tr{top:10px;right:10px;text-align:right}
.dicom-overlay-bl{bottom:10px;left:10px}
.dicom-overlay-br{bottom:10px;right:10px;text-align:right}
.viewer-controls{position:absolute;top:10px;left:50%;transform:translateX(-50%);z-index:10;display:flex;gap:6px}
.vc-btn{background:rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.2);color:rgba(255,255,255,0.8);padding:6px 12px;border-radius:6px;font-size:10px;font-weight:600;letter-spacing:0.08em;transition:all .15s;backdrop-filter:blur(4px)}
.vc-btn:hover{background:rgba(0,170,255,0.3);border-color:var(--accent);color:white}
.vc-btn.on{background:rgba(0,170,255,0.4);border-color:var(--accent);color:white}
.wl-slider{position:absolute;bottom:20px;left:50%;transform:translateX(-50%);z-index:10;display:flex;gap:16px;background:rgba(0,0,0,0.6);padding:10px 20px;border-radius:10px;backdrop-filter:blur(4px)}
.slider-group{display:flex;flex-direction:column;align-items:center;gap:4px}
.slider-label{font-size:9px;color:rgba(255,255,255,0.5);letter-spacing:0.08em}
.slider-group input[type=range]{width:100px;accent-color:var(--accent)}

/* Modality-specific DICOM visuals */
.dicom-ct{background:radial-gradient(ellipse at center,#2a2a2a 0%,#111 60%,#000 100%)}
.dicom-mri{background:radial-gradient(ellipse at 40% 40%,#1a1a3a 0%,#080820 60%,#000 100%)}
.dicom-xr{background:radial-gradient(ellipse at center,#1a1a1a 0%,#050505 100%)}
.dicom-us{background:radial-gradient(ellipse at center,#0a1520 0%,#000 100%)}
.dicom-nm{background:radial-gradient(ellipse at center,#1a0a2a 0%,#050010 100%)}

/* SVG anatomy layers */
.anatomy-svg{position:absolute;inset:0;width:100%;height:100%;opacity:0.85;z-index:2}

.report-side{background:var(--bg1);border-left:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden}
.report-header{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.rh-title{font-family:var(--font-h);font-size:16px;font-style:italic;color:var(--text0)}
.rep-section{padding:12px 16px;border-bottom:1px solid var(--border)}
.rep-section label{font-size:9px;font-weight:700;letter-spacing:0.1em;color:var(--text2);text-transform:uppercase;display:block;margin-bottom:6px}
.rep-textarea{
  width:100%;background:var(--bg2);border:1px solid var(--border);border-radius:6px;
  color:var(--text0);font-family:var(--font-m);font-size:11px;font-weight:300;
  line-height:1.6;padding:8px 10px;resize:none;transition:border-color .2s;
}
.rep-textarea:focus{border-color:var(--border2)}
.rep-actions{padding:12px 16px;display:flex;flex-direction:column;gap:8px;margin-top:auto}
.rep-btn{padding:9px 14px;border-radius:8px;font-size:11px;font-weight:700;letter-spacing:0.06em;transition:all .2s;display:flex;align-items:center;justify-content:center;gap:6px}
.rep-btn.primary{background:var(--nhs2);color:white;border:none}
.rep-btn.primary:hover{background:#003f9e;box-shadow:var(--glow)}
.rep-btn.secondary{background:transparent;color:var(--accent);border:1px solid var(--accent)}
.rep-btn.secondary:hover{background:var(--bg-hover)}
.rep-btn.danger{background:transparent;color:var(--urgent);border:1px solid var(--urgent)}
.dictate-row{display:flex;gap:6px}
.mic-btn{
  background:rgba(232,0,30,0.1);border:1px solid rgba(232,0,30,0.3);color:var(--urgent);
  padding:7px 12px;border-radius:6px;font-size:12px;transition:all .2s;flex-shrink:0;
}
.mic-btn.rec{background:rgba(232,0,30,0.25);animation:mpr 1s ease-in-out infinite;border-color:var(--urgent)}
@keyframes mpr{0%,100%{box-shadow:none}50%{box-shadow:var(--glow-r)}}
.ai-btn{background:rgba(0,212,170,0.1);border:1px solid rgba(0,212,170,0.3);color:var(--accent2);padding:7px 12px;border-radius:6px;font-size:11px;font-weight:700;letter-spacing:0.06em;transition:all .2s}
.ai-btn:hover{background:rgba(0,212,170,0.2)}

/* ══════════════════════════════════════════ ARIA AVATAR */
.aria-panel{
  background:var(--bg1);border-left:1px solid var(--border);
  display:flex;flex-direction:column;overflow:hidden;min-width:0;
}
.aria-avatar-area{
  padding:20px;display:flex;flex-direction:column;align-items:center;
  border-bottom:1px solid var(--border);background:var(--bg2);
  background:linear-gradient(180deg,var(--bg2) 0%,var(--bg1) 100%);
  position:relative;overflow:hidden;
}
.aria-avatar-area::before{
  content:'';position:absolute;inset:0;
  background:radial-gradient(ellipse at 50% 0%,rgba(0,170,255,0.06) 0%,transparent 70%);
  pointer-events:none;
}
/* ARIA SVG FACE */
.aria-face-wrap{position:relative;width:100px;height:120px;margin-bottom:10px}
.aria-face-svg{width:100%;height:100%;filter:drop-shadow(0 8px 24px rgba(0,100,200,0.3))}
.aria-name{font-family:var(--font-h);font-size:18px;font-style:italic;color:var(--text0);margin-bottom:2px}
.aria-sub{font-size:9px;color:var(--text2);letter-spacing:0.1em;margin-bottom:12px;text-align:center}
.aria-state{
  font-size:9px;font-weight:700;letter-spacing:0.12em;padding:3px 12px;border-radius:10px;
  border:1px solid var(--border2);color:var(--accent);background:rgba(0,170,255,0.08);
  margin-bottom:10px;
}
.aria-state.listening{color:var(--urgent);border-color:var(--urgent);background:rgba(232,0,30,0.08)}
.aria-state.speaking{color:var(--accent2);border-color:var(--accent2);background:rgba(0,212,170,0.08)}
.voice-controls{display:flex;gap:6px;margin-bottom:8px}
.vc-small{padding:6px 12px;border-radius:8px;font-size:10px;font-weight:700;letter-spacing:0.06em;transition:all .15s}
.vc-mic{background:rgba(232,0,30,0.1);border:1px solid rgba(232,0,30,0.3);color:var(--urgent)}
.vc-mic:hover{background:rgba(232,0,30,0.2)}
.vc-mic.on{background:rgba(232,0,30,0.3);animation:mpr 1s ease-in-out infinite}
.vc-mute{background:var(--bg3);border:1px solid var(--border);color:var(--text1)}
.voice-sel{background:var(--bg2);border:1px solid var(--border);color:var(--text1);border-radius:6px;padding:5px 8px;font-size:10px;width:100%}
.aria-captions{
  background:rgba(0,0,0,0.4);border-radius:6px;padding:10px 12px;margin-top:8px;
  font-size:11px;color:var(--text1);font-family:var(--font-m);font-weight:300;
  line-height:1.6;min-height:48px;border:1px solid var(--border);width:100%;
  font-style:italic;
}
[data-theme="light"] .aria-captions{background:rgba(0,30,80,0.05)}
.aria-chat{flex:1;overflow-y:auto;padding:10px}
.aria-input-row{padding:10px;border-top:1px solid var(--border);display:flex;gap:6px}
.aria-input{flex:1;background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:8px 12px;color:var(--text0);font-size:12px;font-family:var(--font-s)}
.aria-input:focus{border-color:var(--border2)}
.aria-input::placeholder{color:var(--text2)}
.aria-send{background:var(--nhs2);color:white;border-radius:8px;padding:8px 14px;font-size:11px;font-weight:700;transition:all .2s}
.aria-send:hover{background:#003f9e}
.msg{margin-bottom:10px;display:flex;flex-direction:column;gap:3px}
.msg-role{font-size:8px;font-weight:700;letter-spacing:0.1em;color:var(--text2);text-transform:uppercase}
.msg-body{font-size:12px;color:var(--text1);line-height:1.6;padding:8px 10px;border-radius:8px;background:var(--bg2);border:1px solid var(--border)}
.msg.aria .msg-body{background:var(--bg-active);border-color:var(--border2);color:var(--text0)}

/* ══════════════════════════════════════════ GENERATOR */
.gen-wrap{padding:24px;overflow-y:auto;height:100%}
.gen-title{font-family:var(--font-h);font-size:26px;font-style:italic;color:var(--text0);margin-bottom:6px}
.gen-sub{font-size:12px;color:var(--text2);margin-bottom:28px}
.gen-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;max-width:800px}
.gen-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--card-r);padding:20px}
.gen-card-title{font-size:11px;font-weight:700;letter-spacing:0.1em;color:var(--text2);text-transform:uppercase;margin-bottom:16px}
.slider-wrap{margin-bottom:16px}
.slider-wrap label{font-size:11px;color:var(--text1);display:flex;justify-content:space-between;margin-bottom:6px}
.slider-wrap label span{font-family:var(--font-m);color:var(--accent);font-weight:500}
.slider-wrap input{width:100%;accent-color:var(--accent)}
.gen-btn{
  background:linear-gradient(135deg,var(--nhs),var(--nhs2));color:white;
  padding:14px 28px;border-radius:10px;font-size:13px;font-weight:700;letter-spacing:0.08em;
  box-shadow:0 4px 16px rgba(0,48,135,0.3);transition:all .2s;
}
.gen-btn:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,48,135,0.4)}
.gen-result{
  margin-top:20px;background:var(--bg2);border:1px solid var(--border);border-radius:var(--card-r);
  padding:20px;max-width:800px;
}
.gen-result-title{font-family:var(--font-h);font-size:18px;font-style:italic;color:var(--ok);margin-bottom:8px}
.gen-stat-row{display:flex;gap:24px;flex-wrap:wrap}
.gen-stat{text-align:center}
.gen-stat-n{font-family:var(--font-h);font-size:32px;font-style:italic;color:var(--accent)}
.gen-stat-l{font-size:10px;color:var(--text2);letter-spacing:0.08em;text-transform:uppercase}

/* ══════════════════════════════════════════ IMPORT/EXPORT */
.ie-wrap{padding:24px;overflow-y:auto;height:100%;max-width:900px}
.ie-title{font-family:var(--font-h);font-size:26px;font-style:italic;color:var(--text0);margin-bottom:24px}
.ie-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px}
.ie-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--card-r);padding:20px}
.ie-card-title{font-size:11px;font-weight:700;letter-spacing:0.1em;color:var(--text2);text-transform:uppercase;margin-bottom:16px;display:flex;align-items:center;gap:6px}
.drop-zone{
  border:2px dashed var(--border2);border-radius:8px;padding:32px;text-align:center;
  cursor:pointer;transition:all .2s;margin-bottom:12px;
}
.drop-zone:hover{border-color:var(--accent);background:var(--bg-hover)}
.drop-zone-icon{font-size:28px;margin-bottom:8px;opacity:0.5}
.drop-zone-text{font-size:12px;color:var(--text2)}
.ie-btn{padding:10px 20px;border-radius:8px;font-size:11px;font-weight:700;letter-spacing:0.06em;transition:all .2s;width:100%;margin-bottom:8px}
.ie-btn.export{background:var(--nhs2);color:white;border:none}
.ie-btn.export:hover{background:#003f9e}
.ie-btn.export-csv{background:transparent;color:var(--accent2);border:1px solid var(--accent2)}
.ie-result{font-size:12px;color:var(--ok);margin-top:10px;font-family:var(--font-m);padding:8px;background:rgba(0,145,77,0.08);border-radius:6px;border:1px solid rgba(0,145,77,0.2)}

/* ══════════════════════════════════════════ ANALYTICS */
.analytics-wrap{padding:24px;overflow-y:auto;height:100%}
.a-title{font-family:var(--font-h);font-size:26px;font-style:italic;color:var(--text0);margin-bottom:24px}
.a-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:24px}
.a-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--card-r);padding:16px;position:relative;overflow:hidden}
.a-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px}
.a-card.blue::before{background:var(--accent)}
.a-card.red::before{background:var(--urgent)}
.a-card.green::before{background:var(--ok)}
.a-card.amber::before{background:var(--warn)}
.a-n{font-family:var(--font-h);font-size:36px;font-style:italic;color:var(--text0);line-height:1}
.a-l{font-size:10px;color:var(--text2);letter-spacing:0.08em;text-transform:uppercase;margin-top:4px}
.a-mod-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:10px}
.a-mod-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--card-r);padding:16px;text-align:center}
.a-mod-n{font-family:var(--font-h);font-size:28px;font-style:italic}
.a-mod-l{font-size:10px;color:var(--text2);letter-spacing:0.08em;margin-top:2px}
.bar-chart{background:var(--bg2);border:1px solid var(--border);border-radius:var(--card-r);padding:20px;margin-top:12px}
.bar-row{display:flex;align-items:center;gap:10px;margin-bottom:10px}
.bar-label{font-size:10px;color:var(--text1);width:120px;font-family:var(--font-m)}
.bar-track{flex:1;height:8px;background:var(--bg3);border-radius:4px;overflow:hidden}
.bar-fill{height:100%;border-radius:4px;transition:width .8s ease}
.bar-val{font-size:10px;color:var(--text2);width:30px;text-align:right;font-family:var(--font-m)}

/* ══════════════════════════════════════════ PATIENT BANNER (patient loaded) */
.patient-banner{
  background:var(--bg1);border-bottom:1px solid var(--border);
  padding:8px 16px;display:flex;align-items:center;gap:0;font-size:11px;
}
.pb-field{padding:0 14px;border-right:1px solid var(--border);display:flex;flex-direction:column;gap:1px}
.pb-field:first-child{padding-left:0}
.pb-field:last-child{border-right:none}
.pb-l{font-size:8px;color:var(--text2);letter-spacing:0.1em;text-transform:uppercase}
.pb-v{color:var(--text0);font-weight:600;font-family:var(--font-m);font-size:12px}
.pb-alert{background:rgba(224,123,0,0.1);border:1px solid rgba(224,123,0,0.3);color:var(--warn);padding:3px 8px;border-radius:4px;font-size:9px;font-weight:700;letter-spacing:0.06em}
.pb-critical{background:rgba(232,0,30,0.1);border:1px solid rgba(232,0,30,0.3);color:var(--urgent);padding:3px 8px;border-radius:4px;font-size:9px;font-weight:700;letter-spacing:0.06em;animation:cfp 1.5s ease-in-out infinite}

/* ══════════════════════════════════════════ MISC */
.section-hdr{font-family:var(--font-h);font-size:14px;font-style:italic;color:var(--text0);margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid var(--border)}
.loading{padding:40px;text-align:center;color:var(--text2);font-size:12px}
.loading::after{content:'...';animation:dots 1.5s infinite}
@keyframes dots{0%{content:''}33%{content:'.'}66%{content:'..'}100%{content:'...'}}
@keyframes fiu{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.fi{animation:fiu .3s ease both}

/* ══════════════════════════════════════════ NO STUDY */
.no-study{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:var(--text2)}
.no-study-icon{font-size:48px;margin-bottom:16px;opacity:0.2}
.no-study-text{font-family:var(--font-h);font-size:20px;font-style:italic;margin-bottom:8px;opacity:0.4}
.no-study-sub{font-size:12px;opacity:0.3}

/* Notifications */
.notif{
  position:fixed;bottom:24px;right:24px;z-index:9999;
  background:var(--bg2);border:1px solid var(--border2);border-radius:10px;
  padding:14px 18px;box-shadow:var(--shadow2);font-size:12px;color:var(--text0);
  animation:notif-in .3s ease both;max-width:320px;
}
.notif.ok{border-color:var(--ok);background:rgba(0,145,77,0.1)}
.notif.err{border-color:var(--urgent);background:rgba(232,0,30,0.1)}
@keyframes notif-in{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const {useState,useEffect,useRef,useCallback} = React;
const API = 'http://localhost:8000';

// ─── UTILITIES ────────────────────────────────────────────────────
const age = dob => { const b=new Date(dob),n=new Date(); return Math.floor((n-b)/31557600000); };
const fmt = d => d ? new Date(d).toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit'}) : '—';
const fmtDate = d => d ? new Date(d).toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'}) : '—';

// ─── ARIA AVATAR (SVG animated face) ──────────────────────────────
function AriaFace({state}) {
  const [blink,setBlink] = useState(false);
  const [mouthOpen,setMouthOpen] = useState(0);
  const [headTilt,setHeadTilt] = useState(0);

  useEffect(()=>{
    const bi = setInterval(()=>{ setBlink(true); setTimeout(()=>setBlink(false),120); }, 3200+Math.random()*2000);
    return ()=>clearInterval(bi);
  },[]);

  useEffect(()=>{
    let interval;
    if(state==='speaking'){
      interval = setInterval(()=>{ setMouthOpen(Math.random()*0.7); setHeadTilt((Math.random()-0.5)*3); },90);
    } else if(state==='listening'){
      interval = setInterval(()=>{ setHeadTilt((Math.random()-0.5)*2); },200);
      setMouthOpen(0.15);
    } else {
      setMouthOpen(0); setHeadTilt(0);
    }
    return ()=>{ clearInterval(interval); };
  },[state]);

  const eyeY = blink ? 62 : 58;
  const eyeH = blink ? 1 : 6;
  const mouth = 66 + mouthOpen * 6;
  const mouthH = mouthOpen * 10;

  return (
    <svg className="aria-face-svg" viewBox="0 0 100 120" xmlns="http://www.w3.org/2000/svg"
         style={{transform:`rotate(${headTilt}deg)`,transition:'transform 0.1s ease'}}>
      <defs>
        <radialGradient id="skinGrad" cx="50%" cy="40%" r="60%">
          <stop offset="0%" stopColor="#f5c8a8"/>
          <stop offset="100%" stopColor="#e8a882"/>
        </radialGradient>
        <radialGradient id="hairGrad" cx="50%" cy="0%" r="80%">
          <stop offset="0%" stopColor="#2c1810"/>
          <stop offset="100%" stopColor="#1a0e08"/>
        </radialGradient>
        <radialGradient id="irisGrad" cx="35%" cy="35%" r="65%">
          <stop offset="0%" stopColor="#5a8fd0"/>
          <stop offset="100%" stopColor="#2a5098"/>
        </radialGradient>
        <filter id="soft"><feGaussianBlur stdDeviation="0.3"/></filter>
        <linearGradient id="neckGrad" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0%" stopColor="#e8a882"/>
          <stop offset="100%" stopColor="#d49060"/>
        </linearGradient>
        <linearGradient id="clothGrad" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0%" stopColor="#003087"/>
          <stop offset="100%" stopColor="#001850"/>
        </linearGradient>
      </defs>
      {/* Neck */}
      <path d="M38 88 Q50 92 62 88 L64 108 Q50 112 36 108 Z" fill="url(#neckGrad)"/>
      {/* Clothing — NHS blue */}
      <path d="M20 115 Q30 100 50 105 Q70 100 80 115 L100 120 L0 120 Z" fill="url(#clothGrad)"/>
      {/* White collar detail */}
      <path d="M44 108 L50 115 L56 108 Q53 110 50 111 Q47 110 44 108 Z" fill="white" opacity="0.8"/>
      {/* Head shape */}
      <ellipse cx="50" cy="55" rx="28" ry="34" fill="url(#skinGrad)"/>
      {/* Hair - top */}
      <path d="M22 42 Q24 18 50 16 Q76 18 78 42 Q72 28 50 26 Q28 28 22 42 Z" fill="url(#hairGrad)"/>
      {/* Hair - side left */}
      <path d="M22 42 Q18 55 20 70 Q26 62 28 55 Z" fill="url(#hairGrad)"/>
      {/* Hair - side right */}
      <path d="M78 42 Q82 55 80 70 Q74 62 72 55 Z" fill="url(#hairGrad)"/>
      {/* Ear left */}
      <ellipse cx="22" cy="58" rx="4" ry="6" fill="#e8a882"/>
      <ellipse cx="22" cy="58" rx="2.5" ry="4" fill="#d49070"/>
      {/* Ear right */}
      <ellipse cx="78" cy="58" rx="4" ry="6" fill="#e8a882"/>
      <ellipse cx="78" cy="58" rx="2.5" ry="4" fill="#d49070"/>
      {/* Eyebrows */}
      <path d="M33 46 Q40 43 46 45" stroke="#3a2010" strokeWidth="1.5" fill="none" strokeLinecap="round"/>
      <path d="M54 45 Q60 43 67 46" stroke="#3a2010" strokeWidth="1.5" fill="none" strokeLinecap="round"/>
      {/* Eyes - whites */}
      <ellipse cx="40" cy={eyeY} rx="7" ry={eyeH} fill="white"/>
      <ellipse cx="60" cy={eyeY} rx="7" ry={eyeH} fill="white"/>
      {/* Iris */}
      {!blink && <>
        <ellipse cx="40" cy={eyeY} rx="4.5" ry="4.5" fill="url(#irisGrad)"/>
        <ellipse cx="60" cy={eyeY} rx="4.5" ry="4.5" fill="url(#irisGrad)"/>
        {/* Pupil */}
        <ellipse cx="40" cy={eyeY} rx="2.5" ry="2.5" fill="#0a0a18"/>
        <ellipse cx="60" cy={eyeY} rx="2.5" ry="2.5" fill="#0a0a18"/>
        {/* Eye highlight */}
        <ellipse cx="38" cy={eyeY-1.5} rx="1.2" ry="1" fill="white" opacity="0.9"/>
        <ellipse cx="58" cy={eyeY-1.5} rx="1.2" ry="1" fill="white" opacity="0.9"/>
      </>}
      {/* Nose */}
      <path d="M48 60 Q46 68 44 70 Q47 72 50 71 Q53 72 56 70 Q54 68 52 60" stroke="#c89070" strokeWidth="1" fill="none" opacity="0.5"/>
      {/* Mouth */}
      <path d={`M38 ${mouth} Q50 ${mouth + mouthH} 62 ${mouth}`} stroke="#c87060" strokeWidth="1.5" fill="none" strokeLinecap="round"/>
      {mouthOpen > 0.1 && <ellipse cx="50" cy={mouth + mouthH/2} rx="10" ry={mouthH/2 + 1} fill="#4a1010" opacity="0.6"/>}
      {mouthOpen > 0.1 && <rect x="44" y={mouth + mouthH/2 - 1} width="12" height="2" rx="1" fill="white" opacity="0.7"/>}
      {/* Subtle cheek blush */}
      <ellipse cx="32" cy="65" rx="6" ry="4" fill="#e07060" opacity="0.15"/>
      <ellipse cx="68" cy="65" rx="6" ry="4" fill="#e07060" opacity="0.15"/>
      {/* State indicator ring */}
      {state==='speaking' && <circle cx="50" cy="55" r="30" fill="none" stroke="#00aaff" strokeWidth="1.5" opacity="0.4" strokeDasharray="4 4"><animateTransform attributeName="transform" type="rotate" from="0 50 55" to="360 50 55" dur="3s" repeatCount="indefinite"/></circle>}
      {state==='listening' && <circle cx="50" cy="55" r="30" fill="none" stroke="#e8001e" strokeWidth="1.5" opacity="0.4"><animate attributeName="r" values="30;33;30" dur="1s" repeatCount="indefinite"/><animate attributeName="opacity" values="0.4;0.1;0.4" dur="1s" repeatCount="indefinite"/></circle>}
    </svg>
  );
}

// ─── DICOM VIEWER (modality-specific SVG anatomy) ─────────────────
function DicomViewer({study, series, selectedSeries}) {
  const mod = study?.modality || 'CT';
  const body = study?.body_part || 'Chest';

  const AnatomySVG = () => {
    if (mod==='CT' && (body==='Head' || body==='Brain')) return (
      <svg className="anatomy-svg" viewBox="0 0 520 520" xmlns="http://www.w3.org/2000/svg">
        <defs><radialGradient id="ctbrain" cx="50%" cy="50%" r="50%"><stop offset="0%" stopColor="#444"/><stop offset="70%" stopColor="#222"/><stop offset="100%" stopColor="#000"/></radialGradient></defs>
        <rect width="520" height="520" fill="#0a0a0a"/>
        <ellipse cx="260" cy="250" rx="180" ry="200" fill="#222" stroke="#555" strokeWidth="3"/>
        <ellipse cx="260" cy="250" rx="160" ry="180" fill="#333" stroke="#444" strokeWidth="1.5"/>
        <path d="M260 80 Q280 150 260 250 Q240 150 260 80" fill="#3a3a3a" stroke="#555" strokeWidth="1"/>
        <path d="M100 250 Q180 230 260 250 Q180 270 100 250" fill="none" stroke="#555" strokeWidth="1"/>
        <path d="M260 250 Q340 230 420 250 Q340 270 260 250" fill="none" stroke="#555" strokeWidth="1"/>
        <ellipse cx="200" cy="230" rx="25" ry="20" fill="#2a2a2a" stroke="#666" strokeWidth="1" opacity="0.8"/>
        <ellipse cx="320" cy="230" rx="25" ry="20" fill="#2a2a2a" stroke="#666" strokeWidth="1" opacity="0.8"/>
        <ellipse cx="260" cy="300" rx="40" ry="30" fill="#1a1a1a" stroke="#444" strokeWidth="1.5"/>
        <ellipse cx="260" cy="200" rx="20" ry="15" fill="#333" stroke="#555" strokeWidth="1"/>
        <path d="M200 120 Q230 110 260 108 Q290 110 320 120" fill="none" stroke="#444" strokeWidth="2" opacity="0.5"/>
      </svg>
    );
    if (mod==='CT' && body==='Chest') return (
      <svg className="anatomy-svg" viewBox="0 0 520 520" xmlns="http://www.w3.org/2000/svg">
        <rect width="520" height="520" fill="#080808"/>
        {/* Ribs */}
        {[0,1,2,3,4,5,6,7].map(i=><ellipse key={i} cx="260" cy={160+i*22} rx={120-i*6} ry="10" fill="none" stroke="#888" strokeWidth="2" opacity="0.6"/>)}
        {/* Lung fields */}
        <ellipse cx="185" cy="270" rx="80" ry="110" fill="#1a1a2a" stroke="#445" strokeWidth="1" opacity="0.7"/>
        <ellipse cx="335" cy="270" rx="80" ry="110" fill="#1a1a2a" stroke="#445" strokeWidth="1" opacity="0.7"/>
        {/* Lung markings */}
        {[0,1,2,3].map(i=><path key={i} d={`M185 ${180+i*30} Q${160+i*8} ${200+i*30} ${185} ${220+i*30}`} fill="none" stroke="#334" strokeWidth="1"/>)}
        {/* Mediastinum */}
        <rect x="230" y="150" width="60" height="160" fill="#222" stroke="#555" strokeWidth="1" rx="10"/>
        {/* Heart */}
        <ellipse cx="248" cy="310" rx="50" ry="60" fill="#2a1a1a" stroke="#664" strokeWidth="2"/>
        {/* Spine */}
        <rect x="245" y="140" width="30" height="220" fill="#666" stroke="#888" strokeWidth="1" rx="4" opacity="0.4"/>
        {[0,1,2,3,4,5,6,7,8,9].map(i=><rect key={i} x="243" y={148+i*22} width="34" height="16" fill="#555" stroke="#777" strokeWidth="1" rx="2"/>)}
      </svg>
    );
    if (mod==='MRI') return (
      <svg className="anatomy-svg" viewBox="0 0 520 520" xmlns="http://www.w3.org/2000/svg">
        <rect width="520" height="520" fill="#050510"/>
        <ellipse cx="260" cy="260" rx="195" ry="210" fill="#0a0a20" stroke="#334" strokeWidth="2"/>
        <ellipse cx="260" cy="260" rx="170" ry="185" fill="#12122a" stroke="#446" strokeWidth="1.5"/>
        {/* White matter bands */}
        {[0,1,2,3,4].map(i=><ellipse key={i} cx="260" cy="250" rx={80+i*22} ry={80+i*20} fill="none" stroke={`rgba(100,120,220,${0.15-i*0.02})`} strokeWidth={4-i*0.5}/>)}
        <path d="M260 80 L260 430" stroke="rgba(150,160,255,0.2)" strokeWidth="2"/>
        <path d="M90 260 L430 260" stroke="rgba(150,160,255,0.2)" strokeWidth="2"/>
        <ellipse cx="210" cy="240" rx="35" ry="30" fill="#1a1a3a" stroke="#558" strokeWidth="1"/>
        <ellipse cx="310" cy="240" rx="35" ry="30" fill="#1a1a3a" stroke="#558" strokeWidth="1"/>
        <ellipse cx="260" cy="310" rx="55" ry="40" fill="#0e0e28" stroke="#446" strokeWidth="2"/>
        <ellipse cx="260" cy="200" rx="28" ry="22" fill="#181838" stroke="#557" strokeWidth="1"/>
      </svg>
    );
    if (mod==='XR') return (
      <svg className="anatomy-svg" viewBox="0 0 520 520" xmlns="http://www.w3.org/2000/svg">
        <rect width="520" height="520" fill="#050505"/>
        {/* Chest X-ray style */}
        <ellipse cx="185" cy="250" rx="100" ry="130" fill="#e8e8e8" opacity="0.08" stroke="#aaa" strokeWidth="1"/>
        <ellipse cx="335" cy="250" rx="100" ry="130" fill="#e8e8e8" opacity="0.08" stroke="#aaa" strokeWidth="1"/>
        {/* Lung markings */}
        {[0,1,2,3,4,5,6].map(i=><line key={i} x1="130" y1={160+i*25} x2={230-i*5} y2={145+i*25} stroke="#999" strokeWidth="0.5" opacity="0.5"/>)}
        {[0,1,2,3,4,5,6].map(i=><line key={i} x1="390" y1={160+i*25} x2={290+i*5} y2={145+i*25} stroke="#999" strokeWidth="0.5" opacity="0.5"/>)}
        {/* Ribs */}
        {[0,1,2,3,4,5].map(i=><path key={i} d={`M ${110+i*10} ${140+i*25} Q 200 ${115+i*20} 260 ${125+i*22} Q 320 ${115+i*20} ${410-i*10} ${140+i*25}`} fill="none" stroke="#ddd" strokeWidth="1.5" opacity={0.5-i*0.06}/>)}
        {/* Heart */}
        <ellipse cx="245" cy="310" rx="65" ry="75" fill="#ccc" opacity="0.12" stroke="#bbb" strokeWidth="1.5"/>
        {/* Trachea */}
        <rect x="252" y="80" width="16" height="100" fill="#ccc" opacity="0.15" rx="8"/>
        {/* Spine */}
        {[0,1,2,3,4,5,6,7,8,9,10].map(i=><rect key={i} x="250" y={100+i*30} width="20" height="24" fill="#eee" opacity="0.25" rx="2"/>)}
        {/* Hila */}
        <ellipse cx="210" cy="230" rx="18" ry="25" fill="#ccc" opacity="0.2" stroke="#999" strokeWidth="1"/>
        <ellipse cx="310" cy="230" rx="18" ry="25" fill="#ccc" opacity="0.2" stroke="#999" strokeWidth="1"/>
        {/* Costophrenic angles */}
        <path d="M90 380 Q130 390 185 385" fill="none" stroke="#aaa" strokeWidth="2"/>
        <path d="M430 380 Q390 390 335 385" fill="none" stroke="#aaa" strokeWidth="2"/>
      </svg>
    );
    if (mod==='US') return (
      <svg className="anatomy-svg" viewBox="0 0 520 520" xmlns="http://www.w3.org/2000/svg">
        <rect width="520" height="520" fill="#020810"/>
        {/* Ultrasound sector shape */}
        <path d="M260 60 L80 440 Q260 480 440 440 Z" fill="#0a1020" stroke="#1a2840" strokeWidth="2"/>
        {/* Ultrasound lines */}
        {[0,1,2,3,4,5,6,7,8,9,10,11,12].map(i=>{const a=-50+i*8; const r=a*Math.PI/180; return <line key={i} x1="260" y1="60" x2={260+380*Math.sin(r)} y2={60+380*Math.cos(r)} stroke="rgba(0,150,255,0.05)" strokeWidth="1"/>;})}
        {/* Depth markers */}
        {[1,2,3,4,5].map(i=><text key={i} x="90" y={100+i*70} fill="rgba(255,255,0,0.4)" fontSize="9" fontFamily="monospace">{i}cm</text>)}
        {/* Liver parenchyma */}
        <ellipse cx="260" cy="280" rx="130" ry="90" fill="#1e2c3a" stroke="#2a4060" strokeWidth="1.5" opacity="0.8"/>
        {/* Kidney */}
        <ellipse cx="360" cy="300" rx="30" ry="45" fill="#162030" stroke="#2a3a50" strokeWidth="1.5" opacity="0.7"/>
        <ellipse cx="360" cy="300" rx="15" ry="28" fill="#0e1828" stroke="#1a2a40" strokeWidth="1"/>
        {/* Portal vein */}
        <path d="M180 260 Q260 250 340 260" fill="none" stroke="#005580" strokeWidth="4" opacity="0.6"/>
        {/* Speckle */}
        {Array.from({length:80}).map((_,i)=><circle key={i} cx={120+Math.random()*280} cy={120+Math.random()*280} r="0.8" fill="rgba(200,220,255,0.15)"/>)}
      </svg>
    );
    // NM / default
    return (
      <svg className="anatomy-svg" viewBox="0 0 520 520" xmlns="http://www.w3.org/2000/svg">
        <rect width="520" height="520" fill="#050008"/>
        <ellipse cx="260" cy="260" rx="180" ry="200" fill="#0a0015" stroke="#2a1040" strokeWidth="2"/>
        {/* Hotspots */}
        {[[180,200,25],[340,200,20],[260,300,35],[200,350,15],[320,350,15],[260,420,20]].map(([x,y,r],i)=>(
          <g key={i}><ellipse cx={x} cy={y} rx={r} ry={r*0.8} fill={`rgba(255,100,50,${0.3+Math.random()*0.3})`}/>
          <ellipse cx={x} cy={y} rx={r*0.5} ry={r*0.4} fill={`rgba(255,200,50,${0.5+Math.random()*0.3})`}/></g>
        ))}
        <text x="16" y="30" fill="rgba(255,255,0,0.5)" fontSize="10" fontFamily="monospace">NM SCAN</text>
      </svg>
    );
  };

  return (
    <div className={`dicom-img dicom-${mod.toLowerCase()}`}>
      <AnatomySVG/>
      <div className="dicom-overlay-tl">
        <div>{study?.last_name?.toUpperCase()}, {study?.first_name}</div>
        <div>{study?.mrn}</div>
        <div>{study?.dob ? fmtDate(study?.dob) : ''} {study?.sex}</div>
      </div>
      <div className="dicom-overlay-tr">
        <div>{study?.modality}</div>
        <div>{fmtDate(study?.acquisition_time)}</div>
        <div>ACC: {study?.accession}</div>
      </div>
      <div className="dicom-overlay-bl">
        <div>SER: {selectedSeries?.series_number || 1}/{series?.length || 1}</div>
        <div>{selectedSeries?.series_description || 'Axial'}</div>
      </div>
      <div className="dicom-overlay-br">
        <div>W: 400 L: 40</div>
        <div>KCH RADIOLOGY</div>
      </div>
    </div>
  );
}

// ─── NOTIFICATION ─────────────────────────────────────────────────
function Notif({msg,type,onClose}) {
  useEffect(()=>{ const t=setTimeout(onClose,3500); return()=>clearTimeout(t); },[]);
  return <div className={`notif ${type}`}>{msg}</div>;
}

// ─── MAIN APP ─────────────────────────────────────────────────────
function App() {
  const [theme,setTheme] = useState('dark');
  const [session,setSession] = useState(null);
  const [loginUser,setLoginUser] = useState('');
  const [loginPass,setLoginPass] = useState('');
  const [loginErr,setLoginErr] = useState('');
  const [loginLoading,setLoginLoading] = useState(false);
  const [nav,setNav] = useState('worklist');
  const [studies,setStudies] = useState([]);
  const [stats,setStats] = useState(null);
  const [selectedStudy,setSelectedStudy] = useState(null);
  const [studyDetail,setStudyDetail] = useState(null);
  const [selectedSeries,setSelectedSeries] = useState(null);
  const [filter,setFilter] = useState({mod:'',status:'',priority:'',search:''});
  const [report,setReport] = useState({indication:'',technique:'',findings:'',impression:'',sign_status:'Draft'});
  const [ariaState,setAriaState] = useState('idle');
  const [ariaMessages,setAriaMessages] = useState([{role:'aria',body:"Hello. I'm ARIA, your Advanced Radiology Intelligence Assistant. I'm here to help with study prioritisation, workflow queries, and report assistance. How can I help you today?"}]);
  const [ariaInput,setAriaInput] = useState('');
  const [ariaCaptions,setAriaCaptions] = useState("Ready. Select a study or ask me anything.");
  const [ariaVoice,setAriaVoice] = useState('nova');
  const [ariaMuted,setAriaMuted] = useState(false);
  const [isRecording,setIsRecording] = useState(false);
  const [dictating,setDictating] = useState(null);
  const [genParams,setGenParams] = useState({patients:50,studies_per_patient:3,critical_pct:15});
  const [genResult,setGenResult] = useState(null);
  const [genLoading,setGenLoading] = useState(false);
  const [importResult,setImportResult] = useState('');
  const [notif,setNotif] = useState(null);
  const [viewerTool,setViewerTool] = useState('pan');
  const fileRef = useRef();

  useEffect(()=>{ document.documentElement.setAttribute('data-theme',theme); },[theme]);

  const notify = (msg,type='ok') => { setNotif({msg,type}); };
  const tok = session?.token;

  // Login
  const handleLogin = async e => {
    e.preventDefault();
    setLoginLoading(true); setLoginErr('');
    try {
      const r = await fetch(`${API}/auth/login`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:loginUser,password:loginPass})});
      if (!r.ok) throw new Error('Invalid username or password');
      const d = await r.json();
      setSession(d);
      await ariaSpeak(`Welcome to ARIA, ${d.username}. Your radiology workbench is ready. ${Math.floor(Math.random()*3)+1} critical studies require immediate attention.`);
    } catch(e){ setLoginErr(e.message); }
    setLoginLoading(false);
  };

  const handleLogout = () => { setSession(null); setStudies([]); setStats(null); setSelectedStudy(null); setStudyDetail(null); };

  // Load worklist
  const loadWorklist = useCallback(async () => {
    if (!tok) return;
    try {
      const params = new URLSearchParams({token:tok,...filter});
      const r = await fetch(`${API}/api/worklist?${params}`);
      const d = await r.json();
      setStudies(d.studies || []);
    } catch(e){ console.error(e); }
  },[tok,filter]);

  const loadStats = useCallback(async () => {
    if (!tok) return;
    try {
      const r = await fetch(`${API}/api/stats?token=${tok}`);
      const d = await r.json();
      setStats(d);
    } catch{}
  },[tok]);

  useEffect(()=>{ if(tok){ loadWorklist(); loadStats(); } },[tok,filter]);

  // Load study detail
  const openStudy = async s => {
    setSelectedStudy(s);
    setNav('viewer');
    try {
      const r = await fetch(`${API}/api/study/${s.study_id}?token=${tok}`);
      const d = await r.json();
      setStudyDetail(d);
      setSelectedSeries(d.series?.[0]||null);
      if(d.report){ setReport({indication:d.report.indication||'',technique:d.report.technique||'',findings:d.report.findings||'',impression:d.report.impression||'',sign_status:d.report.sign_status||'Draft'}); }
      else { setReport({indication:s.indication||'',technique:`${s.modality} ${s.body_part}`,findings:'',impression:'',sign_status:'Draft'}); }
      if(s.critical_flag){ ariaSpeak(`Critical study loaded. ${s.description}. Immediate review required.`); }
      else { ariaSpeak(`Study loaded: ${s.description} for ${s.first_name} ${s.last_name}.`); }
    } catch(e){ console.error(e); }
  };

  // ARIA speak
  const ariaSpeak = async text => {
    setAriaCaptions(text);
    if(ariaMuted) return;
    setAriaState('speaking');
    try {
      const r = await fetch(`${API}/api/aria/speak?token=${tok}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text,voice:ariaVoice})});
      if(!r.ok) throw new Error();
      const blob = await r.blob();
      const audio = new Audio(URL.createObjectURL(blob));
      audio.onended = ()=>setAriaState('idle');
      await audio.play();
    } catch { setTimeout(()=>setAriaState('idle'),text.length*60); }
  };

  // ARIA text query
  const ariaQuery = async q => {
    if(!q.trim()) return;
    setAriaMessages(m=>[...m,{role:'user',body:q}]);
    setAriaInput('');
    setAriaState('thinking');
    try {
      const r = await fetch(`${API}/api/aria/query?token=${tok}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({query:q})});
      const d = await r.json();
      setAriaMessages(m=>[...m,{role:'aria',body:d.response}]);
      await ariaSpeak(d.response);
    } catch(e){ setAriaMessages(m=>[...m,{role:'aria',body:'ARIA is temporarily unavailable. Please try again.'}]); setAriaState('idle'); }
  };

  // Report save
  const saveReport = async () => {
    if(!studyDetail) return;
    try {
      const existing = studyDetail.report;
      if(existing){
        await fetch(`${API}/api/report/${existing.report_id}?token=${tok}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(report)});
      } else {
        await fetch(`${API}/api/report?token=${tok}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({...report,study_id:selectedStudy.study_id})});
      }
      notify('Report saved successfully');
    } catch(e){ notify('Failed to save report','err'); }
  };

  // AI assist report
  const aiAssistReport = async () => {
    if(!selectedStudy) return;
    setAriaState('thinking');
    try {
      const r = await fetch(`${API}/api/aria/assist-report?token=${tok}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({modality:selectedStudy.modality,body_part:selectedStudy.body_part,indication:report.indication,findings:report.findings})});
      const d = await r.json();
      setReport(prev=>({...prev,impression:d.suggestion}));
      ariaSpeak('AI-assisted impression has been added to the report. Please review before signing.');
    } catch(e){ notify('AI assist failed','err'); }
  };

  // Generate dataset
  const generateDataset = async () => {
    setGenLoading(true);
    try {
      const r = await fetch(`${API}/api/generate?token=${tok}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(genParams)});
      const d = await r.json();
      setGenResult(d);
      await loadWorklist(); await loadStats();
      notify(`Generated ${d.patients} patients, ${d.studies} studies`);
    } catch(e){ notify('Generation failed','err'); }
    setGenLoading(false);
  };

  // Export
  const handleExport = async fmt => {
    try {
      const r = await fetch(`${API}/api/export?token=${tok}&fmt=${fmt}`);
      const blob = await r.blob();
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download=`aria_worklist.${fmt}`; a.click();
      notify(`Exported as ${fmt.toUpperCase()}`);
    } catch(e){ notify('Export failed','err'); }
  };

  // Import
  const handleImport = async file => {
    const form = new FormData(); form.append('file',file);
    try {
      const r = await fetch(`${API}/api/import?token=${tok}`,{method:'POST',body:form});
      const d = await r.json();
      setImportResult(`✓ Imported ${d.imported} records successfully`);
      await loadWorklist(); await loadStats();
      notify(`Imported ${d.imported} records`);
    } catch(e){ setImportResult('Import failed — check file format'); }
  };

  // Priority colour
  const priClass = p => p==='Emergency'?'pri-e':p==='Urgent'?'pri-u':'pri-r';
  const rsClass = s => s==='Unreported'?'rs-U':s==='Preliminary'?'rs-P':s==='Final'?'rs-F':'rs-D';

  // ── LOGIN ──────────────────────────────────────────────────────
  if(!session) return (
    <div className="login-wrap">
      <div className="login-card">
        <div className="login-avatar">A</div>
        <div className="login-title">ARIA</div>
        <div className="login-sub">Advanced Radiology Intelligence Assistant</div>
        <div style={{textAlign:'center',marginBottom:'28px'}}><span className="login-badge">NHS PROTOTYPE</span></div>
        {loginErr && <div className="login-error">{loginErr}</div>}
        <form onSubmit={handleLogin}>
          <label className="login-label">Username</label>
          <input className="login-input" type="text" placeholder="Enter username" value={loginUser} onChange={e=>setLoginUser(e.target.value)} autoFocus/>
          <label className="login-label">Password</label>
          <input className="login-input" type="password" placeholder="Enter password" value={loginPass} onChange={e=>setLoginPass(e.target.value)}/>
          <button className="login-btn" type="submit" disabled={loginLoading}>{loginLoading?'Signing in...':'SIGN IN TO ARIA'}</button>
        </form>
        <div className="login-confidential">CONFIDENTIAL — Authorised Access Only</div>
        <div className="login-footer">This system is for NHS staff only. Not for clinical decision making.<br/>King's College Hospital NHS Foundation Trust<br/><br/><span style={{opacity:0.5}}>Demo: david / kings2024</span></div>
      </div>
    </div>
  );

  // ── MAIN APP ────────────────────────────────────────────────────
  const RAIL_ITEMS = [
    {id:'worklist',icon:'☰',label:'List'},
    {id:'viewer',icon:'⬜',label:'Viewer'},
    {id:'analytics',icon:'▦',label:'Stats'},
    {id:'import',icon:'↑',label:'I/O'},
    {id:'generator',icon:'⚙',label:'Gen'},
  ];

  return (
    <div className="app">
      {/* TOPBAR */}
      <div className="topbar">
        <div className="topbar-logo"><div className="nhs-sq">NHS</div></div>
        <div className="topbar-brand">
          <h1>ARIA Radiology Workbench</h1>
          <p>KING'S COLLEGE HOSPITAL NHS FOUNDATION TRUST · DENMARK HILL SE5</p>
        </div>
        <div className="topbar-banner">
          {selectedStudy ? <>
            <div className="banner-field"><div className="bf-label">Patient</div><div className="bf-val">{selectedStudy.last_name?.toUpperCase()}, {selectedStudy.first_name}</div></div>
            <div className="banner-field"><div className="bf-label">MRN</div><div className="bf-val">{selectedStudy.mrn}</div></div>
            <div className="banner-field"><div className="bf-label">DOB / Age</div><div className="bf-val">{fmtDate(selectedStudy.dob)} ({age(selectedStudy.dob)}y)</div></div>
            <div className="banner-field"><div className="bf-label">Sex</div><div className="bf-val">{selectedStudy.sex}</div></div>
            <div className="banner-field"><div className="bf-label">Modality</div><div className="bf-val">{selectedStudy.modality} · {selectedStudy.body_part}</div></div>
            {selectedStudy.critical_flag==1 && <div className="banner-field"><div className="pb-critical">⚠ CRITICAL</div></div>}
            {(() => { try { const a=JSON.parse(selectedStudy.allergies||'[]'); return a.length&&a[0]!=='None known'?<div className="banner-field"><div className="bf-label">Allergies</div><div className="bf-val alert">{a.slice(0,2).join(', ')}</div></div>:null; } catch{ return null; } })()}
          </> : <div style={{color:'rgba(255,255,255,0.3)',fontSize:'12px',padding:'0 16px'}}>No study selected — select from worklist</div>}
        </div>
        <div className="topbar-right">
          <div className="live-pill"><div className="live-d"/>LIVE</div>
          {stats && <div style={{fontSize:'10px',color:'rgba(255,255,255,0.5)',fontFamily:'var(--font-m)'}}>{stats.total} studies · {stats.critical} critical</div>}
          <div className="theme-tog">
            <button className={`ttb ${theme==='dark'?'on':''}`} onClick={()=>setTheme('dark')}>DARK</button>
            <button className={`ttb ${theme==='light'?'on':''}`} onClick={()=>setTheme('light')}>LIGHT</button>
          </div>
          <div className="topbar-user">
            <div className="user-chip">👤 {session.username}</div>
            <button className="logout-btn" onClick={handleLogout}>SIGN OUT</button>
          </div>
        </div>
      </div>

      {/* RAIL */}
      <div className="rail">
        {RAIL_ITEMS.map(item=>(
          <button key={item.id} className={`rail-btn ${nav===item.id?'active':''}`} onClick={()=>setNav(item.id)}>
            <span className="rail-icon">{item.icon}</span>
            <span className="rail-label">{item.label}</span>
          </button>
        ))}
        <div className="rail-spacer"/>
        <div className="rail-divider"/>
        <button className="rail-btn" onClick={handleLogout} title="Sign out">
          <span className="rail-icon">⏻</span>
          <span className="rail-label">Out</span>
        </button>
      </div>

      {/* WORKSPACE */}
      <div className="workspace">

        {/* ── WORKLIST ── */}
        {nav==='worklist' && (
          <div className="wl-wrap">
            <div className="wl-toolbar">
              <div className="wl-title">Radiology Worklist</div>
              <div className="search-box">
                <span style={{color:'var(--text2)'}}>🔍</span>
                <input placeholder="Search patient, MRN, description..." value={filter.search} onChange={e=>setFilter(f=>({...f,search:e.target.value}))}/>
              </div>
              <select className="filter-sel" value={filter.mod} onChange={e=>setFilter(f=>({...f,mod:e.target.value}))}>
                <option value="">All Modalities</option>
                {['CT','MRI','XR','US','NM'].map(m=><option key={m} value={m}>{m}</option>)}
              </select>
              <select className="filter-sel" value={filter.status} onChange={e=>setFilter(f=>({...f,status:e.target.value}))}>
                <option value="">All Statuses</option>
                {['Unreported','Preliminary','Final'].map(s=><option key={s} value={s}>{s}</option>)}
              </select>
              <select className="filter-sel" value={filter.priority} onChange={e=>setFilter(f=>({...f,priority:e.target.value}))}>
                <option value="">All Priorities</option>
                {['Emergency','Urgent','Routine'].map(p=><option key={p} value={p}>{p}</option>)}
              </select>
              {stats && <>
                <span className="wl-stat red">⚠ {stats.critical} Critical</span>
                <span className="wl-stat amb">{stats.unreported} Unreported</span>
                <span className="wl-stat grn">{stats.total} Total</span>
              </>}
            </div>
            <div className="table-wrap">
              {studies.length===0 ? (
                <div className="empty-state">
                  <div className="empty-icon">📋</div>
                  <div>No studies found</div>
                  <div style={{marginTop:'8px',fontSize:'11px'}}>Use the Generator to create demo data, or adjust filters</div>
                </div>
              ) : (
                <table>
                  <thead>
                    <tr>
                      <th>Priority</th><th>Patient</th><th>MRN</th><th>DOB</th><th>Sex</th>
                      <th>Modality</th><th>Study Description</th><th>Body Part</th>
                      <th>Ordering Clinician</th><th>Scheduled</th><th>Report Status</th><th>⚠</th>
                    </tr>
                  </thead>
                  <tbody>
                    {studies.map(s=>(
                      <tr key={s.study_id} className={selectedStudy?.study_id===s.study_id?'active-row':''} onClick={()=>openStudy(s)}>
                        <td><span className={`pri-badge ${priClass(s.priority)}`}>{s.priority}</span></td>
                        <td className="primary">{s.last_name}, {s.first_name}</td>
                        <td style={{fontFamily:'var(--font-m)',fontSize:'10px'}}>{s.mrn}</td>
                        <td style={{fontSize:'10px'}}>{fmtDate(s.dob)}</td>
                        <td>{s.sex}</td>
                        <td><span className={`mod-tag m-${s.modality}`}>{s.modality}</span></td>
                        <td style={{maxWidth:'240px',overflow:'hidden',textOverflow:'ellipsis'}}>{s.description}</td>
                        <td>{s.body_part}</td>
                        <td style={{fontSize:'10px'}}>{s.ordering_clinician}</td>
                        <td style={{fontFamily:'var(--font-m)',fontSize:'10px'}}>{s.scheduled_time?.slice(11,16)} {s.scheduled_time?.slice(5,10)}</td>
                        <td><span className={`rs-badge ${rsClass(s.report_status)}`}>{s.report_status}</span></td>
                        <td>{s.critical_flag==1 && <span className="crit-flag">⚠</span>}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              )}
            </div>
          </div>
        )}

        {/* ── VIEWER ── */}
        {nav==='viewer' && (
          !selectedStudy ? (
            <div className="no-study">
              <div className="no-study-icon">🔬</div>
              <div className="no-study-text">No Study Selected</div>
              <div className="no-study-sub">Select a study from the worklist to begin</div>
            </div>
          ) : (
            <div className="viewer-wrap">
              {/* Series Panel */}
              <div className="series-panel">
                <div className="series-title">Series</div>
                {studyDetail?.series?.map(ser=>(
                  <div key={ser.series_id} className={`series-item ${selectedSeries?.series_id===ser.series_id?'active':''}`} onClick={()=>setSelectedSeries(ser)}>
                    <div className="series-num">Series {ser.series_number}</div>
                    <div className="series-desc">{ser.series_description}</div>
                  </div>
                ))}
                <div className="series-title" style={{marginTop:'16px'}}>Study Info</div>
                <div style={{fontSize:'10px',color:'var(--text2)',lineHeight:'1.8',fontFamily:'var(--font-m)'}}>
                  <div><span style={{color:'var(--text2)'}}>MOD:</span> <span style={{color:'var(--text0)'}}>{selectedStudy.modality}</span></div>
                  <div><span style={{color:'var(--text2)'}}>ACC:</span> <span style={{color:'var(--text0)',fontSize:'9px'}}>{selectedStudy.accession}</span></div>
                  <div><span style={{color:'var(--text2)'}}>ACQ:</span> <span style={{color:'var(--text0)'}}>{selectedStudy.acquisition_time?.slice(0,16)}</span></div>
                  <div style={{marginTop:'8px',color:'var(--text1)'}}>{selectedStudy.description}</div>
                </div>
              </div>

              {/* Canvas */}
              <div className="viewer-canvas">
                <div className="viewer-controls">
                  {['Pan','Zoom','Measure','Annotate','WL'].map(t=>(
                    <button key={t} className={`vc-btn ${viewerTool===t.toLowerCase()?'on':''}`} onClick={()=>setViewerTool(t.toLowerCase())}>{t}</button>
                  ))}
                </div>
                <DicomViewer study={selectedStudy} series={studyDetail?.series} selectedSeries={selectedSeries}/>
                <div className="wl-slider">
                  <div className="slider-group"><div className="slider-label">WINDOW</div><input type="range" min="1" max="800" defaultValue="400"/></div>
                  <div className="slider-group"><div className="slider-label">LEVEL</div><input type="range" min="-200" max="400" defaultValue="40"/></div>
                  <div className="slider-group"><div className="slider-label">ZOOM</div><input type="range" min="50" max="300" defaultValue="100"/></div>
                </div>
              </div>

              {/* Report Side */}
              <div className="report-side">
                <div className="report-header">
                  <div className="rh-title">Report Editor</div>
                  <span className={`rs-badge ${rsClass(studyDetail?.report?.sign_status||report.sign_status)}`}>{studyDetail?.report?.sign_status||report.sign_status||'Draft'}</span>
                </div>
                <div style={{overflowY:'auto',flex:1}}>
                  {[{key:'indication',label:'Indication',rows:2},{key:'technique',label:'Technique',rows:2},{key:'findings',label:'Findings',rows:5},{key:'impression',label:'Impression',rows:3}].map(({key,label,rows})=>(
                    <div key={key} className="rep-section">
                      <label>{label}</label>
                      <div className="dictate-row">
                        <textarea className="rep-textarea" rows={rows} value={report[key]} onChange={e=>setReport(r=>({...r,[key]:e.target.value}))}/>
                      </div>
                    </div>
                  ))}
                  <div className="rep-section">
                    <button className="ai-btn" onClick={aiAssistReport}>✦ AI Assist Impression</button>
                  </div>
                </div>
                <div className="rep-actions">
                  <button className="rep-btn primary" onClick={saveReport}>💾 Save Report</button>
                  <button className="rep-btn primary" onClick={()=>{setReport(r=>({...r,sign_status:'Final'}));saveReport();notify('Report signed and finalised')}}>✓ Sign & Finalise</button>
                  <button className="rep-btn secondary" onClick={()=>notify('Addendum mode — type below')}>+ Add Addendum</button>
                </div>
              </div>
            </div>
          )
        )}

        {/* ── ANALYTICS ── */}
        {nav==='analytics' && (
          <div className="analytics-wrap">
            <div className="a-title">Department Analytics</div>
            <div className="a-grid">
              <div className="a-card blue"><div className="a-n">{stats?.total||0}</div><div className="a-l">Total Studies</div></div>
              <div className="a-card red"><div className="a-n">{stats?.critical||0}</div><div className="a-l">Critical Findings</div></div>
              <div className="a-card amber"><div className="a-n">{stats?.unreported||0}</div><div className="a-l">Unreported</div></div>
              <div className="a-card green"><div className="a-n">{stats?.patients||0}</div><div className="a-l">Patients</div></div>
            </div>
            <div style={{fontSize:'11px',fontWeight:'700',letterSpacing:'0.1em',color:'var(--text2)',textTransform:'uppercase',marginBottom:'10px'}}>Modality Breakdown</div>
            <div className="a-mod-grid">
              {['CT','MRI','XR','US','NM'].map(m=>(
                <div key={m} className="a-mod-card">
                  <div className={`a-mod-n mod-tag m-${m}`} style={{background:'none',padding:0}}>{stats?.modalities?.[m]||0}</div>
                  <div className="a-mod-l">{m}</div>
                </div>
              ))}
            </div>
            <div className="bar-chart" style={{marginTop:'20px'}}>
              <div style={{fontSize:'11px',fontWeight:'700',letterSpacing:'0.1em',color:'var(--text2)',textTransform:'uppercase',marginBottom:'16px'}}>Volume by Modality</div>
              {['CT','MRI','XR','US','NM'].map(m=>{
                const max=Math.max(...['CT','MRI','XR','US','NM'].map(x=>stats?.modalities?.[x]||0))||1;
                const n=stats?.modalities?.[m]||0;
                const colors={CT:'var(--accent)',MRI:'var(--accent2)',XR:'var(--warn)',US:'#9b81ff',NM:'#ff80d0'};
                return <div key={m} className="bar-row">
                  <div className="bar-label">{m}</div>
                  <div className="bar-track"><div className="bar-fill" style={{width:`${(n/max)*100}%`,background:colors[m]}}/></div>
                  <div className="bar-val">{n}</div>
                </div>;
              })}
            </div>
          </div>
        )}

        {/* ── IMPORT / EXPORT ── */}
        {nav==='import' && (
          <div className="ie-wrap">
            <div className="ie-title">Import & Export</div>
            <div className="ie-grid">
              <div className="ie-card">
                <div className="ie-card-title">↑ Import Data</div>
                <div className="drop-zone" onClick={()=>fileRef.current?.click()} onDragOver={e=>e.preventDefault()} onDrop={e=>{e.preventDefault();const f=e.dataTransfer.files[0];if(f)handleImport(f);}}>
                  <div className="drop-zone-icon">📂</div>
                  <div className="drop-zone-text">Drop CSV or JSON file here<br/>or click to browse</div>
                </div>
                <input type="file" accept=".csv,.json" ref={fileRef} style={{display:'none'}} onChange={e=>e.target.files[0]&&handleImport(e.target.files[0])}/>
                {importResult && <div className="ie-result">{importResult}</div>}
                <div style={{marginTop:'16px',fontSize:'11px',color:'var(--text2)',lineHeight:'1.8'}}>
                  <div style={{fontWeight:'700',marginBottom:'6px',color:'var(--text1)'}}>Expected CSV columns:</div>
                  <div style={{fontFamily:'var(--font-m)',fontSize:'10px'}}>mrn, first_name, last_name, dob, sex</div>
                </div>
              </div>
              <div className="ie-card">
                <div className="ie-card-title">↓ Export Data</div>
                <button className="ie-btn export" onClick={()=>handleExport('json')}>Export as JSON</button>
                <button className="ie-btn export-csv" onClick={()=>handleExport('csv')}>Export as CSV</button>
                <div style={{marginTop:'16px',fontSize:'11px',color:'var(--text2)',lineHeight:'1.8'}}>
                  Exports current worklist with patient demographics, study details, modalities, priorities and report statuses.
                </div>
              </div>
            </div>
          </div>
        )}

        {/* ── GENERATOR ── */}
        {nav==='generator' && (
          <div className="gen-wrap">
            <div className="gen-title">Dataset Generator</div>
            <div className="gen-sub">Generate realistic synthetic radiology patients and studies for demonstration purposes</div>
            <div className="gen-grid">
              <div className="gen-card">
                <div className="gen-card-title">Patient Parameters</div>
                {[{key:'patients',label:'Number of Patients',min:10,max:200,step:10},{key:'studies_per_patient',label:'Studies per Patient',min:1,max:8,step:1},{key:'critical_pct',label:'Critical Finding %',min:0,max:50,step:5}].map(({key,label,min,max,step})=>(
                  <div key={key} className="slider-wrap">
                    <label>{label} <span>{genParams[key]}{key==='critical_pct'?'%':''}</span></label>
                    <input type="range" min={min} max={max} step={step} value={genParams[key]} onChange={e=>setGenParams(p=>({...p,[key]:parseInt(e.target.value)}))}/>
                  </div>
                ))}
              </div>
              <div className="gen-card">
                <div className="gen-card-title">Study Mix Preview</div>
                <div style={{fontSize:'12px',color:'var(--text1)',lineHeight:'2.0'}}>
                  <div>📊 Est. studies: <strong style={{color:'var(--accent)'}}>{genParams.patients * genParams.studies_per_patient}</strong></div>
                  <div>⚠ Est. critical: <strong style={{color:'var(--urgent)'}}>{Math.round(genParams.patients * genParams.studies_per_patient * genParams.critical_pct / 100)}</strong></div>
                  <div style={{marginTop:'12px',fontSize:'10px',color:'var(--text2)'}}>Modality distribution: CT 30% · MRI 18% · XR 25% · US 18% · NM 9%</div>
                  <div style={{marginTop:'8px',fontSize:'10px',color:'var(--text2)'}}>Includes realistic: study descriptions · clinician names · ordering locations · report statuses · contrast flags · critical findings</div>
                </div>
              </div>
            </div>
            <div style={{marginTop:'24px'}}>
              <button className="gen-btn" onClick={generateDataset} disabled={genLoading}>{genLoading?'Generating...':'⚙ GENERATE DATASET'}</button>
            </div>
            {genResult && (
              <div className="gen-result fi">
                <div className="gen-result-title">✓ Dataset Generated Successfully</div>
                <div className="gen-stat-row">
                  <div className="gen-stat"><div className="gen-stat-n">{genResult.patients}</div><div className="gen-stat-l">Patients</div></div>
                  <div className="gen-stat"><div className="gen-stat-n">{genResult.studies}</div><div className="gen-stat-l">Studies</div></div>
                  <div className="gen-stat"><div className="gen-stat-n">{Math.round(genResult.studies*genParams.critical_pct/100)}</div><div className="gen-stat-l">Est. Critical</div></div>
                </div>
                <div style={{marginTop:'12px',fontSize:'11px',color:'var(--text2)'}}>Navigate to Worklist to browse generated data →</div>
              </div>
            )}
          </div>
        )}

      </div>{/* end workspace */}

      {/* ARIA SIDE PANEL (always visible) */}
      <div className="aria-panel" style={{position:'fixed',right:0,top:'var(--header)',bottom:0,width:'280px',zIndex:50,borderLeft:'1px solid var(--border)',display:nav==='viewer'?'none':'flex',flexDirection:'column'}}>
        <div className="aria-avatar-area">
          <div className="aria-face-wrap"><AriaFace state={ariaState}/></div>
          <div className="aria-name">ARIA</div>
          <div className="aria-sub">ADVANCED RADIOLOGY INTELLIGENCE ASSISTANT</div>
          <div className={`aria-state ${ariaState==='listening'?'listening':ariaState==='speaking'?'speaking':''}`}>
            {ariaState==='idle'?'READY':ariaState==='speaking'?'SPEAKING':ariaState==='listening'?'LISTENING':'THINKING'}
          </div>
          <div className="voice-controls">
            <button className={`vc-small vc-mic ${isRecording?'on':''}`} onClick={()=>setIsRecording(r=>!r)}>{isRecording?'⏹ Stop':'🎙 Talk'}</button>
            <button className={`vc-small vc-mute`} onClick={()=>setAriaMuted(m=>!m)}>{ariaMuted?'🔇 Muted':'🔊 Audio'}</button>
          </div>
          <select className="voice-sel" value={ariaVoice} onChange={e=>setAriaVoice(e.target.value)}>
            <option value="nova">Voice: Nova (default)</option>
            <option value="alloy">Voice: Alloy</option>
            <option value="shimmer">Voice: Shimmer</option>
          </select>
          <div className="aria-captions">{ariaCaptions}</div>
        </div>
        <div className="aria-chat">
          {ariaMessages.map((m,i)=>(
            <div key={i} className={`msg ${m.role}`}>
              <div className="msg-role">{m.role==='aria'?'ARIA':'You'}</div>
              <div className="msg-body">{m.body}</div>
            </div>
          ))}
        </div>
        <div className="aria-input-row">
          <input className="aria-input" value={ariaInput} onChange={e=>setAriaInput(e.target.value)} placeholder="Ask ARIA..." onKeyDown={e=>e.key==='Enter'&&ariaQuery(ariaInput)}/>
          <button className="aria-send" onClick={()=>ariaQuery(ariaInput)}>➤</button>
        </div>
      </div>

      {/* NOTIFICATION */}
      {notif && <Notif msg={notif.msg} type={notif.type} onClose={()=>setNotif(null)}/>}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
